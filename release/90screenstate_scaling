#!/system/bin/sh

# screenstate_scaling, governor and threshold control
# original by 'FloHimself'(florian.schaefer@gmail.com)
# modifications by 'zacharias.maladroit' and 'well.heeled.man'

# Further modifications by Efpophis (billcrossley@gmail.com)
# soon: an app to control my extra options

# as it turns out, I get better battery life without this running
# at all. Maybe the thing polling constantly is draining
# the battery faster than if it was just left alone...

# see if we have a config directory
if [ ! -d /sdcard/Glitch_config ]
then
	mkdir -p /sdcard/Glitch_config
	# use conservative for asleep
	echo "conservative" > /sdcard/Glitch_config/sleep_gov

	# screenstate scaling active. set to anything but active
	# to disable. to re-activate, set to active and reboot
	echo "inactive" > /sdcard/Glitch_config/screenstate_scaling

	# perhaps more options to come ?
fi

if [ -r /sdcard/Glitch_config/screenstate_scaling ]
then
	SCREENSTATE_SCALING_ACTIVE=`cat /sdcard/Glitch_config/screenstate_scaling`
else
	SCREENSTATE_SCALING_ACTIVE="inactive"
fi


# use the one voltage control has specified, maybe?
# assumes 1. we're awake at start, and 2. that VC has set the governor according to user wishes.
AWAKE_GOVERNOR=`cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor`


if [ -r /sdcard/Glitch_config/sleep_gov ]
then
	SLEEP_GOVERNOR=`cat /sdcard/Glitch_config/sleep_gov`
else
	SLEEP_GOVERNOR="conservative"
fi

# Polling for AWAKE_GOVERNOR state.

(while [ $SCREENSTATE_SCALING_ACTIVE = "active" ]
do
    # the "cat" call blocks on these files if the device is not in the state being checked for
    # meaning execution will wait here until the phone wakes up. Neat.
    AWAKE=`cat /sys/power/wait_for_fb_wake`
    
    if [ $AWAKE = "awake" ]; then
	echo $AWAKE_GOVERNOR > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

	# adjust some stuff based on what gov we're using
	case "$AWAKE_GOVERNOR" in

	# =========
	# Smartass settings (slightly more battery friendly than Glitch Kernel defaults - peformance penalty unclear)
	# =========
	'smartass')
		echo "50" > /sys/devices/system/cpu/cpu0/cpufreq/smartass/max_cpu_load
		echo "30" > /sys/devices/system/cpu/cpu0/cpufreq/smartass/min_cpu_load
		echo "800000" > /sys/devices/system/cpu/cpu0/cpufreq/smartass/up_min_freq
		echo "400000" > /sys/devices/system/cpu/cpu0/cpufreq/smartass/sleep_max_freq
	;;

	# =========
	# Ondemand settings [more aggressive power savings vs. standard ondemand]
	# =========
	'ondemand')
		echo "98" > /sys/devices/system/cpu/cpufreq/ondemand/up_threshold
		echo "300000" > /sys/devices/system/cpu/cpu0/cpufreq/ondemand/sampling_rate
	;;

	# =========
	# Conservative settings [SavagedZen governor-like] (conservative AWAKE_GOVERNOR)
	# =========
	'conservative')

		echo "75" > /sys/devices/system/cpu/cpufreq/conservative/up_threshold
		echo "30" > /sys/devices/system/cpu/cpufreq/conservative/down_threshold
		echo "50" > /sys/devices/system/cpu/cpufreq/conservative/freq_step
		echo "80000" > /sys/devices/system/cpu/cpu0/cpufreq/conservative/sampling_rate
	;;
	esac

AWAKE=
    fi

    # the "cat" call blocks on these files if the device is not in the state being checked for
    # meaning execution will wait here until the phone goes to sleep. Neat.
    SLEEPING=`cat /sys/power/wait_for_fb_sleep`
    
    if [ $SLEEPING = "sleeping" ]; then
    
	# save the current awake gov for restoration later - someone may have changed it
	# we can do this since coming into this if statement is edge-sensitive, i/e: it
	# only happens when the state initially transitions to "sleeping"
	AWAKE_GOVERNOR=`cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor`

        echo $SLEEP_GOVERNOR > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

	case "$SLEEP_GOVERNOR" in

		# =========
		# Conservative settings [very conservative](conservative SLEEP_GOVERNOR)
		# =========
		'conservative')

			echo "90" > /sys/devices/system/cpu/cpufreq/conservative/up_threshold
	        	echo "50" > /sys/devices/system/cpu/cpufreq/conservative/down_threshold
			echo "10" > /sys/devices/system/cpu/cpufreq/conservative/freq_step
			echo "500000" > /sys/devices/system/cpu/cpu0/cpufreq/conservative/sampling_rate
		;;

		#==========
		# Powersave settings - nothing here is relevant since powersave sticks to
		# the lowest allowable freq. Note that this gov will
		# probably be WORSE on power than conservative.
		#==========
		'powersave')
			# nothing to do here - placeholder in case someone else wants to get fancy
		;;

	esac

	# Finishing.

	SLEEPING=
    fi
    
    # they can deactivate by removing or setting to something other than "active"
    if [ -r /sdcard/Glitch_config/screenstate_scaling ]
    then
	SCREENSTATE_SCALING_ACTIVE=`cat /sdcard/Glitch_config/screenstate_scaling`
    else
	SCREENSTATE_SCALING_ACTIVE="inactive"
    fi

done &)
